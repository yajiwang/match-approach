---
title: "Matching OpenAlex author IDs with Twitter accounts"
author: "Philippe Mongeon"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true 
    toc_float:       
      collapsed: false
    toc_depth: 2
    number_sections: false 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

# Summary

This code uses the APIs of OpenAlex, Crossref, and Twitter to fetch the potential Twitter accounts of an OpenAlex author. The only requirement to run this code is a bearer token for the Twitter API, which you can obtain at <https://developer.twitter.com/>.

# Setup

## Load the packages.

```{r load libraries}
library(tidyverse)
library(stringi)
library(DT)
library(httr)
library(openalexR)
library(rtweet)
```

## Set email for API calls

```{r set_email}
email <- "" 
```

# Get author names and works

The following part of the code calls the OpenAlex API to retrieve the DOIs of works authored by a provided author ID.

## Set OpenAlex Author ID

First, we create a variable with the ID (**in URL form**) of the author we want to find on Twitter. You can look up researchers here: <https://explore.openalex.org/>

```{r set_id}
author_id <- "" 
```

## Retrieve author information from OpenAlex API

```{r get_author_info}

# This code sets the URL for the API call.
author_url <- str_replace(author_id,"https://openalex.org","https://api.openalex.org") 

# This makes the API call and stores the data into a list.
openalex_author_data <- openalexR::oa_request(author_url, mailto = email)
```

## Author names

OpenAlex has two name columns for each author ID: display_name, and diplay_name_alternatives. This code creates a tibble with one column combining the display_name and all display_name_alternatives for our author. In this example, there are no display_name_alternatives for the author, so only one row is returned.

```{r get names}
# Get the author names
author_name <-openalex_author_data$display_name
display_name <- author_name # We will use this at the very end

# Get the alternative names
author_alternate_names <- openalex_author_data$display_name_alternatives

i=1
while (i <= length(author_alternate_names)) {
  author_name <- c(display_name, author_alternate_names[[i]])
  i=i+1
}

author <- tibble(author_id = author_id,
                 author_name = author_name)

DT::datatable(author, rownames = F)
```

## Get all the author's works

The next step is to collect the DOIs of all the works of our authors. This can be done with the **works_api_url** information included into the data retrieved in the previous step. The code below retrieve the author's works using the API and creates a data frame with only the DOIs.

```{r get_works}
# This creates a list with all the works
works<- oa_request(openalex_author_data$works_api_url,
                     mailto = email) 

# This creates a tibble with the DOIs of the works.
dois <- tibble()
for (i in 1:length(works)) {
dois <- bind_rows(dois, works_data <- tibble(doi = works[[i]]$doi))
}

DT::datatable(dois, rownames = F)
```

# Identify tweeters of the works

Here we use the Crossref Event Data API to collect a distinct list of Twitter users who have tweeted at least one of the works in our list.

```{r get_tweeters}

# Creates an empty vector to collect the handle of the Tweeters.
handles <- character()

# For each paper...
for (d in 1:nrow(dois)) {
  doi<-dois[d,]$doi
  
  # Collect the tweets...
  tweets <- GET(str_c("https://api.eventdata.crossref.org/v1/events?mailto=",email,"&obj-id=",dois[d,]$doi,"&source=twitter&rows=1000", sep = ""))
  
  # and the tweeters
  tweeters <- content(tweets, "parsed")$message$events

  # add tweeters' handle to vector of unique handles 
  t = 1
  while (t <= length(tweeters)) {
    handles <- c(handles,tweeters[[t]]$subj_id) %>% unique()
    handles <- c(handles,tweeters[[t]]$subj$`original-tweet-author`) %>% unique()
    t=t+1
  }
}

# This extracts the the twitter handle from the tweet url and stores the handles in a tibble
handles <- str_replace_all(handles, ".*.com/","")
handles <- str_replace_all(handles, ".*screen_name\\=","")
handles <- str_replace_all(handles, "/.*","")
handles <- tibble(handles = handles) %>%
             filter(handles != "twitter:") %>% 
             unique()

DT::datatable(handles %>% 
             arrange(handles),
             rownames = F)
```

# Fetch tweeters' profile names

Because the Crossref data does not include the profile name of the Tweeters, we need to get those using the Twitter API. So, this is where you will need to use your identifiers for the Twitter API.

```{r twitter_credentials}
auth_setup_default() # You might need to run this code to authenticate yoursef with Twitter
bearer <- "" # Your bearer token for the Twitter API
appname <- "" # Name of your app for the Twitter API
```

Once authenticated, we can fetch the names using this code:

**Note:** this step might take several minutes. you will get error messages in your console when a handle is not found on Twitter. This is normal and you should keep the code running.

```{r}

#set an interval for the API calls
interval = 2 

# loop to populate the users tibble
users <- tibble()
h = 1
repeat {
  tryCatch(expr = {
    startTime = Sys.time()
    id <- rtweet::lookup_users(handles[h,]$handles)$id
    twt_url <- str_c("https://api.twitter.com/2/users/",id,"?user.fields=name",sep = "")
    twitter_profile <- GET(twt_url, add_headers(Authorization = paste("Bearer", bearer, sep = " ")))

    users <- bind_rows(users,tibble(tweeter_id = id,
                                  handle = handles[h,]$handles,
                                  profile_name = content(twitter_profile, "parsed")$data$name))
 
    sleepTime = startTime + interval - Sys.time()
    if (sleepTime > 0) {
      Sys.sleep(sleepTime)
      }
  },
    error = function(e){
            message(str_c(id, " not found on Twitter"))
            print(e)
        }
  )

  h <- h+1
  
  if (h > nrow(handles)) {
    break()
  }
} 

# create a tibble with a the handle and cleaned user name for all the Tweeters of all DOI in our list recorded in Crossref Event Data
users <- users %>% 
  unique() %>% 
  mutate(profile_name = iconv(profile_name,"latin1","ASCII", sub="")) %>% 
  mutate(profile_name = str_squish(profile_name))

DT::datatable(users, rownames = F)
```

# Name variants for matching

This next bit of code, which is certainly longer than it really needs to be, creates author name and tweeter name variants based on the tokens that compose the names. It also separates the variants in 5 columns: first name, last name, initials, first token, and first initials. These columns are used for the matching at the next step.

## Tweeters' name variations

```{r}
    users_token <- users %>%
      mutate(token = profile_name) %>% 
      separate_rows(token,
                    sep = " ") %>%
      group_by(tweeter_id, profile_name) %>% 
      mutate(token_number = row_number()) %>% 
      mutate(tokens = max(token_number)) %>% 
      mutate(token = stri_trans_general(str = token, id = "Latin-ASCII")) %>% 
      mutate(token = str_replace_all(token, "\\."," ")) %>% 
      mutate(token = str_squish(str_to_lower(token))) %>% 
      ungroup %>% 
      pivot_wider(names_from = token_number,
                  values_from = token)
    
users_name_variants <- tibble()
# 2 tokens
output <- users_token %>% 
  filter(tokens == 2) %>% 
  mutate(first_name = `1`,
         last_name = `2`,
         initials = str_sub(`1`,1,1),
         first_token = `1`,
         first_initial = str_sub(`1`,1,1)) %>% 
  select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial)

users_name_variants <- bind_rows(users_name_variants, output) %>% 
  unique()

# 3 tokens 
if (ncol(users_token) >= 7) {
output <- bind_rows(users_token %>%
                      filter(tokens == 3) %>% 
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>% 
                      mutate(last_name = str_c(`3`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), str_sub(`2`,1,1), sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id,
                             profile_name,
                             first_name,
                             last_name,
                             initials,
                             first_initial),
                      users_token %>% 
                        filter(tokens == 3) %>%
                        mutate(first_name = str_c(`1`, sep = " ")) %>%
                        mutate(last_name = str_c(`2`,`3`, sep = " ")) %>%
                        mutate(first_token = `1`) %>% 
                        mutate(initials = str_c(str_sub(`1`,1,1), 
                                                sep = "")) %>%
                        mutate(first_token = `1`) %>% 
                        mutate(first_initial = str_sub(`1`,1,1)) %>% 
                        select(tweeter_id,
                               profile_name,
                               first_name,
                               last_name,
                               initials,
                               first_initial)
                      )

users_name_variants <- bind_rows(users_name_variants, output) %>% 
  unique()


}

# 4 tokens 
if(ncol(users_token)>=8) {
output <- bind_rows(users_token %>%
                      filter(tokens == 4) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`, sep = " ")) %>% 
                      mutate(last_name = str_c(`4`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 4) %>%
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1), 
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 4) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial)
)

users_name_variants <- bind_rows(users_name_variants, output) %>% 
  unique()

}
# 5 tokens
if (ncol(users_token) >= 9) {
output <- bind_rows(users_token %>%
                      filter(tokens == 5) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`, sep = " ")) %>% 
                      mutate(last_name = str_c(`5`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 5) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`, sep = " ")) %>%
                      mutate(last_name = str_c(`4`,`5`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 5) %>%
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`,`5`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 5) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`,`5`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial)
                    
)

users_name_variants <- bind_rows(users_name_variants, output) %>% 
  unique()

}

# 6 tokens
if (ncol(users_token) >= 10) {

output <- bind_rows(users_token %>%
                      filter(tokens == 6) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`,`5`, sep = " ")) %>% 
                      mutate(last_name = str_c(`6`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              str_sub(`5`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`, sep = " ")) %>%
                      mutate(last_name = str_c(`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`, sep = " ")) %>%
                      mutate(last_name = str_c(`4`,`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`, `2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`,`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`,`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial)
                    
)
users_name_variants <- bind_rows(users_name_variants, output) %>% 
  unique()
}
# 7 tokens
if (ncol(users_token) >= 11) {
output <- bind_rows(users_token %>%
                      filter(tokens == 7) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`,`5`,`6`, sep = " ")) %>% 
                      mutate(last_name = str_c(`7`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              str_sub(`5`,1,1),
                                              str_sub(`6`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`,`5`, sep = " ")) %>%
                      mutate(last_name = str_c(`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              str_sub(`5`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`, sep = " ")) %>%
                      mutate(last_name = str_c(`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`, `2`, `3`, sep = " ")) %>%
                      mutate(last_name = str_c(`4`,`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`,`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial),
                    users_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`,`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(tweeter_id, handle, profile_name, first_name, last_name, initials, first_token, first_initial)
)

users_name_variants <- bind_rows(users_name_variants, output) %>% 
  unique()


}

DT::datatable(users_name_variants, rownames = F)
```

## Author's name variations

```{r}
   author_token <- author %>%
      mutate(token = author_name) %>% 
      separate_rows(token,
                    sep = " ") %>%
      group_by(author_id, author_name) %>% 
      mutate(token_number = row_number()) %>% 
      mutate(tokens = max(token_number)) %>% 
      mutate(token = stri_trans_general(str = token, id = "Latin-ASCII")) %>% 
      mutate(token = str_replace_all(token, "\\."," ")) %>% 
      mutate(token = str_squish(str_to_lower(token))) %>% 
      ungroup %>% 
      pivot_wider(names_from = token_number,
                  values_from = token)
    
author_name_variants <- tibble()
# 2 tokens
output <- author_token %>% 
  filter(tokens == 2) %>% 
  mutate(first_name = `1`,
         last_name = `2`,
         initials = str_sub(`1`,1,1),
         first_token = `1`,
         first_initial = str_sub(`1`,1,1)) %>% 
  select(author_id, author_name, first_name, last_name, initials, first_token, first_initial)

author_name_variants <- bind_rows(author_name_variants, output) %>% 
  unique()

# 3 tokens 
if (ncol(author_token) >= 6) {
output <- bind_rows(author_token %>%
                      filter(tokens == 3) %>% 
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>% 
                      mutate(last_name = str_c(`3`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), str_sub(`2`,1,1), sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id,
                             author_name,
                             first_name,
                             last_name,
                             initials,
                             first_initial),
                      author_token %>% 
                        filter(tokens == 3) %>%
                        mutate(first_name = str_c(`1`, sep = " ")) %>%
                        mutate(last_name = str_c(`2`,`3`, sep = " ")) %>%
                        mutate(first_token = `1`) %>% 
                        mutate(initials = str_c(str_sub(`1`,1,1), 
                                                sep = "")) %>%
                        mutate(first_token = `1`) %>% 
                        mutate(first_initial = str_sub(`1`,1,1)) %>% 
                        select(author_id,
                               author_name,
                               first_name,
                               last_name,
                               initials,
                               first_initial)
                      )

author_name_variants <- bind_rows(author_name_variants, output) %>% 
  unique()


}

# 4 tokens 
if(ncol(author_token)>=7) {
output <- bind_rows(author_token %>%
                      filter(tokens == 4) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`, sep = " ")) %>% 
                      mutate(last_name = str_c(`4`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 4) %>%
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1), 
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 4) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial)
)

author_name_variants <- bind_rows(author_name_variants, output) %>% 
  unique()

}
# 5 tokens
if (ncol(author_token) >= 8) {
output <- bind_rows(author_token %>%
                      filter(tokens == 5) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`, sep = " ")) %>% 
                      mutate(last_name = str_c(`5`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 5) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`, sep = " ")) %>%
                      mutate(last_name = str_c(`4`,`5`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 5) %>%
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`,`5`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 5) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`,`5`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial)
                    
)

author_name_variants <- bind_rows(author_name_variants, output) %>% 
  unique()

}

# 6 tokens
if (ncol(author_token) >= 9) {

output <- bind_rows(author_token %>%
                      filter(tokens == 6) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`,`5`, sep = " ")) %>% 
                      mutate(last_name = str_c(`6`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              str_sub(`5`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`, sep = " ")) %>%
                      mutate(last_name = str_c(`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`, sep = " ")) %>%
                      mutate(last_name = str_c(`4`,`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`, `2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`,`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 6) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`,`5`,`6`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial)
                    
)
author_name_variants <- bind_rows(author_name_variants, output) %>% 
  unique()
}
# 7 tokens
if (ncol(author_token) >= 10) {
output <- bind_rows(author_token %>%
                      filter(tokens == 7) %>% 
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`,`5`,`6`, sep = " ")) %>% 
                      mutate(last_name = str_c(`7`, sep = " ")) %>% 
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              str_sub(`5`,1,1),
                                              str_sub(`6`,1,1),
                                              sep = "")) %>% 
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`,`5`, sep = " ")) %>%
                      mutate(last_name = str_c(`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1), 
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              str_sub(`5`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`,`2`,`3`,`4`, sep = " ")) %>%
                      mutate(last_name = str_c(`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              str_sub(`4`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`, `2`, `3`, sep = " ")) %>%
                      mutate(last_name = str_c(`4`,`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              str_sub(`3`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`,`2`, sep = " ")) %>%
                      mutate(last_name = str_c(`3`,`4`,`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              str_sub(`2`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial),
                    author_token %>% 
                      filter(tokens == 7) %>%
                      mutate(first_name = str_c(`1`, sep = " ")) %>%
                      mutate(last_name = str_c(`2`,`3`,`4`,`5`,`6`,`7`, sep = " ")) %>%
                      mutate(initials = str_c(str_sub(`1`,1,1),
                                              sep = "")) %>%
                      mutate(first_token = `1`) %>% 
                      mutate(first_initial = str_sub(`1`,1,1)) %>% 
                      select(author_id, author_name, first_name, last_name, initials, first_token, first_initial)
)

author_name_variants <- bind_rows(author_name_variants, output) %>% 
  unique()%>% 
  unnest(author_name)
}

DT::datatable(author_name_variants, rownames = F)
```

# Matching

This code looks for matches between the names of the tweeting users and the author and returns the matching Twitter accounts along with a list of the matching criteria that produced each matches.

```{r}
users_name_variants <- users_name_variants %>% 
  mutate(handle_clean = str_to_lower(str_remove_all(handle,"[^[:alpha:]]")))
author_name_variants <- author_name_variants %>% 
  mutate(display_name = display_name)

matches <- bind_rows(
  author_name_variants %>% 
    inner_join(users_name_variants, by=c("first_name","last_name")) %>% 
    mutate(criteria = "full name (profile name)") %>% 
    unique(),
  author_name_variants %>% 
    crossing(users_name_variants, .name_repair="universal") %>% 
    filter(str_detect(str_remove_all(str_to_lower(profile_name)," "), str_c(first_name...3, last_name...4))) %>% 
    mutate(criteria = "Substring (profile name)") %>% 
    unique(),
  author_name_variants %>% 
    inner_join(users_name_variants, by=c("first_token","last_name")) %>% 
    mutate(criteria = "Last name + first token (profile name)") %>% 
    unique(),
  author_name_variants %>% 
    inner_join(users_name_variants, by=c("initials","last_name")) %>% 
    select(author_id, display_name, tweeter_id, handle, profile_name) %>% 
    mutate(criteria = "Last name + initials (profile name)") %>% 
    unique(),
  author_name_variants %>% 
    inner_join(users_name_variants, by=c("first_initial","last_name")) %>% 
    mutate(criteria = "Last name + first initial (profile name)") %>% 
    unique(),
  author_name_variants %>% 
    mutate(handle_clean = str_c(first_name,last_name)) %>% 
    inner_join(users_name_variants, by="handle_clean") %>% 
    mutate(criteria = "Full name (handle)") %>% 
    unique(),
  author_name_variants %>% 
    mutate(handle_clean = str_c(first_token,last_name)) %>% 
    inner_join(users_name_variants, by="handle_clean") %>% 
    mutate(criteria = "Last name + first token (handle)") %>% 
    unique(),
  author_name_variants %>% 
    mutate(handle_clean = str_c(initials,last_name)) %>% 
    inner_join(users_name_variants, by="handle_clean") %>% 
    mutate(criteria = "Last name + initials (handle)") %>% 
    unique(),
  author_name_variants %>% 
    mutate(handle_clean = str_c(first_initial,last_name)) %>% 
    inner_join(users_name_variants, by="handle_clean") %>% 
    mutate(criteria = "Last name + first initial (handle)") %>% 
    unique()) %>% 
  group_by(author_id, tweeter_id, handle, profile_name) %>% 
  mutate(criteria = paste(criteria, collapse=", ")) %>%
  select(author_id, display_name, tweeter_id, handle, profile_name, criteria) %>% 
  unique()
  
DT::datatable(matches, rownames = F)
```

# Conclusion

Through this example, we found that the OpenAlex author id A1923114979(display name: Philippe Mongeon) is most likely the same person who has the Twitter account 25273765 (handle: philippemongeon; profile name: Philippe Mongeon).

# Reference

Please cite the following paper when using this code:

\
Mongeon, P., Bowman, T. D., & Costas, R. (2022). *An open dataset of scholars on Twitter* (arXiv:2208.11065). arXiv. <https://doi.org/10.48550/arXiv.2208.11065>
